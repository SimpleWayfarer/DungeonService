<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Hello!</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding-top: 50px; }
        .card { border: 1px solid #ccc; padding: 20px; border-radius: 8px; width: 300px; }
        input { width: 100%; margin: 10px 0; padding: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; cursor: pointer; background: #ed4545; color: white; border: none; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card" id="auth-card">
    <h2 id="title">Вход</h2>
    <input type="text" id="username" placeholder="Имя пользователя">
    <input type="password" id="password" placeholder="Пароль">
    <button onclick="handleAuth()" id="main-btn">Войти</button>
    <p style="text-align: center; font-size: 0.8em;">
        <a href="#" onclick="toggleMode()" id="toggle-link">Нет аккаунта? Зарегистрироваться</a>
    </p>
</div>

<div class="card hidden" id="welcome-card">
    <h2>Привет, <span id="user-display"></span>! </h2>
    <p>Доброй пожаловать!</p>
    <button onclick="location.reload()">Выйти</button>
</div>

<script>
    window.onload = async function() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        if (token && username) {
            const res = await fetch('api/validate', {
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (res.ok) {
                showWelcome(username);
            } else {
                logout();
            }
        }
    };

    function showWelcome(username) {
        document.getElementById('auth-card').classList.add('hidden');
        document.getElementById('welcome-card').classList.remove('hidden');
        document.getElementById('user-display').innerText = username;
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        location.reload();
    }


    let isLogin = true;

    function toggleMode() {
        isLogin = !isLogin;
        document.getElementById('title').innerText = isLogin ? 'Вход' : 'Регистрация';
        document.getElementById('main-btn').innerText = isLogin ? 'Войти' : 'Создать аккаунт';
        document.getElementById('toggle-link').innerText = isLogin ? 'Нет аккаунта? Зарегистрироваться' : 'Уже есть аккаунт? Войти';
    }

    async function handleAuth() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const endpoint = isLogin ? '/api/login' : '/api/register';

        const res = await fetch(`${endpoint}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: u, password: p})
        });

        const data = await res.json();
        if (res.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('username', data.username);
            showWelcome(data.username);
        } else {
            alert(data.detail || 'Ошибка авторизации');
        }
    }
</script>
</body>
</html>
